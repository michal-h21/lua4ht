\ProvidesPackage{lua4ht}
\RequirePackage{luacode, etoolbox}

\@ifpackageloaded{tex4ht}{}{%
%\RequirePackage[xhtml, charset=utf-8, mathml, new-accents]{tex4ht}
}

\begin{luacode*}
local math_clb = require "math-machine"
clb  = require "node-machine"
font_machine = require "font-machine"
local patch_latin1 = require "l4patchlatin1"
luatexbase.add_to_callback("open_read_file", patch_latin1, "Convert html4.4ht to utf8")
luatexbase.add_to_callback('mlist_to_hlist',
function(head, display, penalty)
  math_clb:run(head)
  return node.mlist_to_hlist(head, display, penalty)
end,"convert to mathml?")
--
local page_clb = function(head)
  return clb:run(head)
end
luatexbase.add_to_callback("pre_output_filter", page_clb,"lua4ht")
\end{luacode*}

\newcommand\registernormal{%                                                    
  % we need to find normal font, it will be left without span elements          
  \setbox0=\hbox{\normalfont a}
  \luaexec{for n in node.traverse_id(37, tex.box[0].head) do
    font_machine.normal(n.font)
  end}
}

\AtBeginDocument{\registernormal}

\AfterEndDocument{%
	\luaexec{%
	  clb:finish()
  }
}
